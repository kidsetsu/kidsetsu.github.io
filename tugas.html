<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Pribadi - Kid Setsu</title>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="header" class="container">
        <h1>Curriculum Vitae</h1>

        <div id="nav">
            <a href="index.html">Beranda</a>
            <a href="formulir.html">Kontak Saya</a>
            <a href="tugas.html">Tugas</a>
        </div>
    </div>

    <div id="main" class="container">
        <h2>Siswa LKP Jaya Negara</h2>

        <div id="siswa" class="loading"></div>
    </div>

    <div id="footer" class="container">
        <p>Copyright 2021 - Kid Setsu - LKP Jaya Negara</p>
    </div>

    <script type="module">
        (async function () {
            const fetchApi = async (endPoint) => {
                try {
                    const res = await fetch(`https://api.github.com/${endPoint}?access_token=c67ac0057d6780ca900388a68ae8e98e1d87ea71`, {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    return res ? res.json?.() : null;
                } catch (err) {
                    console.error(err);
                    return null;
                }
            }

            const following = await fetchApi('users/kidsetsu/following');
            const students = await fetch('siswa.json')
                .then(res => res.json())
                .then(students => students.sort((a, b) => {
                    a = a.name.toLowerCase()
                    b = b.name.toLowerCase()
                    return a < b ? -1 : b < a ? 1 : 0;
                }));

            const fetchStudent = async (student) => {
                let page_url = student.username.toLowerCase();

                return Promise.all([
                    fetchApi(`users/${student.username}`),
                    fetchApi(`repos/${student.username}/${student.username}`),
                    fetchApi(`repos/${student.username}/${student.username}.github.io`)
                ]).then(([profile, repo, page]) => {
                    student.avatar_url = profile.avatar_url || null
                    student.repo_url = repo.html_url || null
                    student.page_url = page.html_url ? `https://${page_url}.github.io` : null
                })
            }

            const $main = document.getElementById('siswa')

            for (let student of students) {
                if (!student.username) continue;

                student.github_url = `https://github.com/${student.username}`
                
                let followed = (following || []).find(user => user.login === student.username) || false;

                if (student.username) {
                    await fetchStudent(student)
                }
            }
            
            students.map(student => {
                const $student = document.createElement('div')
                $student.classList.add('separo', 'siswa')

                const $avatar = document.createElement('img')
                $avatar.alt = student.name
                $avatar.src = student.avatar_url
                    ? `${student.avatar_url}&s=100`
                    : 'no-img.png'
                $student.appendChild($avatar)

                let $github, $repo, $page
                const $name = document.createElement('h4')
                $name.innerText = student.name
                $student.appendChild($name)

                const $links = document.createElement('div')

                if (student.github_url) {
                    $github = document.createElement('a')
                    $github.href = student.github_url
                    $github.target = '_blank'
                    $github.innerText = '✅ Github'
                } else {
                    $github = document.createElement('span')
                    $github.innerText = '❌ Github'
                }
                $links.appendChild($github)

                if (student.repo_url) {
                    $repo = document.createElement('a')
                    $repo.href = student.repo_url
                    $repo.target = '_blank'
                    $repo.innerText = '✅ Repository'
                } else {
                    $repo = document.createElement('span')
                    $repo.innerText = '❌ Repository'
                }
                $links.appendChild($repo)

                if (student.page_url) {
                    $page = document.createElement('a')
                    $page.href = student.page_url
                    $page.target = '_blank'
                    $page.innerText = '✅ Website'
                } else {
                    $page = document.createElement('span')
                    $page.innerText = '❌ Website'
                }
                $links.appendChild($page)

                $student.appendChild($links);
                $main.appendChild($student);
            })

            $main.classList.toggle('loading');
        })()
    </script>
</body>

</html>