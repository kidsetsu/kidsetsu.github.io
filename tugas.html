<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Pribadi - Kid Setsu</title>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="header" class="container">
        <h1>Curriculum Vitae</h1>

        <div id="nav">
            <a href="index.html">Beranda</a>
            <a href="formulir.html">Kontak Saya</a>
            <a href="tugas.html">Tugas</a>
        </div>
    </div>

    <div id="main" class="container">
        <h2>Siswa LKP Jaya Negara</h2>

        <div id="siswa" class="loading"></div>
    </div>

    <div id="footer" class="container">
        <p>Copyright 2021 - Kid Setsu - LKP Jaya Negara</p>
    </div>

    <script type="module">
        (async function () {
            const fetchApi = (endPoint) => {
                return fetch(`https://api.github.com/${endPoint}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': 'token bce5c6bbe93ab3ac10658a78608cabafce2aab81'
                    }
                }).then(res => res.json());
            }

            if (location.search === '?clear') {
                localStorage.clear()
                location.href = location.pathname
            }

            const following = await fetchApi('users/kidsetsu/following') || [];
            let students = await fetch('siswa.json')
                .then(res => res.json())
                .then(students => students.sort((a, b) => {
                    a = a.name.toLowerCase()
                    b = b.name.toLowerCase()
                    return a < b ? -1 : b < a ? 1 : 0;
                }));
            
            students = await Promise.all(students.map(async (student) => {
                if (!student.username) return student

                const cached = localStorage.getItem(student.username)

                if (cached) {
                    return Object.assign({}, student, JSON.parse(cached))
                }

                const repos = await fetchApi(`users/${student.username}/repos`)
                const repo = repos.find(repo => repo.name === student.username)
                const page = repos.find(repo => 
                    repo.name.toLowerCase() === `${student.username.toLowerCase()}.github.io`)
                
                if (repo) {
                    student.github_url = repo.owner.html_url
                    student.avatar_url = repo.owner.avatar_url
                    student.repo_url = repo.html_url
                }
                
                if (page && page.has_pages) {
                    const page_url = `https://${student.username.toLowerCase()}.github.io`;

                    try {
                        student.site = await fetch(page_url, { method: 'HEAD' });

                        student.has_page = student.site.status === 200;
                        student.page_url = student.has_page ? page_url : page.html_url;
                    } catch(err) {
                        console.error(err);
                    }
                }

                localStorage.setItem(student.username, JSON.stringify(student))

                return Object.assign({}, student)
            }))

            const newLink = (url, title, has_link) => {
                let $link
                let check = has_link ? '✅' : '❌'

                if (url) {
                    $link = document.createElement('a')
                    $link.href = url
                    $link.target = '_blank'
                    $link.innerText = `${check} ${title}`
                } else {
                    $link = document.createElement('span')
                    $link.innerText = `❌ ${title}`
                }
                return $link;
            }

            const $main = document.getElementById('siswa')
            
            students.map(student => {
                const $student = document.createElement('div')
                $student.classList.add('separo', 'siswa')

                const $avatar = document.createElement('img')
                $avatar.alt = student.name
                $avatar.src = student.avatar_url
                    ? `${student.avatar_url}&s=100`
                    : 'no-img.png'
                $student.appendChild($avatar)

                const $name = document.createElement('h4')
                $name.innerText = student.name
                $student.appendChild($name)

                const $links = document.createElement('div')

                $links.appendChild(newLink(student.github_url, 'GitHub', student.github_url?.includes(student.username)))
                $links.appendChild(newLink(student.repo_url, 'Repository', student.repo_url?.includes(student.username)))
                $links.appendChild(newLink(student.page_url, 'Website', student.has_page))

                $student.appendChild($links);
                $main.appendChild($student);
            })

            console.info(students)

            $main.classList.toggle('loading');
        })()
    </script>
</body>

</html>